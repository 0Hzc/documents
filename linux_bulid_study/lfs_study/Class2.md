### 🏛️ 第二课：构建 LFS 的地基 —— 分区与文件系统

既然环境检查工具已经准备好了，我们现在正式进入 LFS 的核心操作。

在真实的物理机上，LFS 手册会让你切分硬盘，格式化一个空分区给 LFS 用。
**但在 WSL2 环境下，我们不能直接把 Windows 的 C 盘给格式化了。**

为了既能保护你的 Windows 数据，又能让你**完整体验** Linux 的磁盘管理（分区、格式化、挂载），我们将采用\*\*“虚拟磁盘镜像 (Loop Device)”\*\* 的方案。

#### 1\. 核心概念：什么是 Loop Device？

  * **物理做法**：你买一块 20GB 的硬盘插在电脑上，它叫 `/dev/sdb`。
  * **虚拟做法**：我们创建一个 20GB 的**大文件**（比如 `lfs.img`），然后告诉 Linux 内核：“请把这个文件当成一块物理硬盘来对待”。
  * **意义**：这样你就可以对这个文件进行 `mkfs.ext4`（格式化）、`mount`（挂载），操作体验和真实硬盘一模一样，而且非常安全（玩坏了删掉文件重来就行）。

#### 2\. LFS 的“地基”结构

我们需要构建如下的目录结构：

  * **$LFS (挂载点)**：通常设置为 `/mnt/lfs`。这是我们在宿主机上访问 LFS 系统的“大门”。
  * **Sources 目录**：`$LFS/sources`。用来存放下载的源码包。
  * **Tools 目录**：`$LFS/tools`。存放我们在第一阶段编译的临时工具链。

-----

### 🛠️ 任务二：虚拟磁盘与挂载脚本

请编写一个脚本 `setup_disk.sh`，完成以下系统级操作。
*(注：由于涉及磁盘操作，这个脚本通常需要 `sudo` 运行)*

**我负责解释步骤（Your Guide）：**

1.  **定义变量**：

      * `LFS_MOUNT=/mnt/lfs`
      * `DISK_IMG=lfs_disk.img`
      * `DISK_SIZE=10G` (给 LFS 10GB 空间足够了)

2.  **创建挂载点**：

      * 检查 `/mnt/lfs` 是否存在，不存在则创建。

3.  **制作虚拟硬盘 (难点)**：

      * **步骤**：检查当前目录下是否有 `lfs_disk.img`。如果没有，使用 `dd` 命令或者 `fallocate` 命令创建一个 10GB 的空文件。
      * *命令提示*：`dd if=/dev/zero of=lfs_disk.img bs=1G count=10` (这会创建一个 10GB 的全零文件)。

4.  **格式化 (Format)**：

      * 新买的硬盘（创建的文件）是一张白纸。我们需要在上面画格子（建立文件系统）。
      * **步骤**：使用 `mkfs.ext4` 将这个文件格式化为 ext4 文件系统。
      * *注意*：`mkfs` 会询问是否对文件进行操作，需要加 `-F` 参数强制执行，或者处理交互。这里建议脚本里先判断一下“是否已经格式化过”，如果太复杂，可以先每次都重新格式化（数据会丢失，小心！）。
      * *更稳妥的逻辑*：如果文件刚被创建（根据 `dd` 的结果），则执行格式化。如果文件早就存在，假设它已经格式化好了，跳过这一步。

5.  **挂载 (Mount)**：

      * **步骤**：将这个大文件挂载到 `/mnt/lfs` 上。
      * *命令提示*：`mount -o loop lfs_disk.img $LFS_MOUNT`。
      * *验证*：挂载后，运行 `df -h $LFS_MOUNT`，应该能看到约 10GB 的可用空间。

6.  **后续目录准备**：

      * 挂载成功后，**在挂载点内部**创建必要的目录：
          * `$LFS_MOUNT/sources` (加粘滞位权限 `chmod a+wt`)
          * `$LFS_MOUNT/tools`
      * 创建 `/tools` 的软链接：在宿主机的根目录创建一个指向 `$LFS_MOUNT/tools` 的软链接 `/tools`。
      * *为什么？* 因为 LFS 的工具链编译时，很多路径写死了是 `/tools`。我们需要让宿主机能通过 `/tools` 直接访问到我们的临时目录。

**这也是一个硬核的系统管理脚本。请尝试编写 `setup_disk.sh`！遇到 `dd` 或 `mkfs` 的参数不确定时，记得查一下 `man` 手册或问我。**